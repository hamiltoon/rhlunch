name: Weekly Test Data Fetch

on:
  schedule:
    # Run every Monday at 11:00 UTC (around lunch time in Sweden)
    - cron: "0 11 * * 1"
    # Test run at 09:24 UTC (10:24 CET)
    - cron: "50 9 * * *"
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  fetch-test-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          # Install only requests library needed for the fetch script
          # cd to /tmp to avoid pip trying to install local package
          cd /tmp
          python -m pip install --upgrade pip
          python -m pip install "requests>=2.31.0"

      - name: Generate branch name
        id: branch
        run: |
          DATE=$(date +%Y-%m-%d)
          BRANCH_NAME="test-data-fetch-${DATE}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT

      - name: Create and checkout new branch
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git checkout -b ${{ steps.branch.outputs.branch_name }}

      - name: Fetch test data
        run: |
          python tests/fixtures/fetch_test_data.py

      - name: Commit changes
        id: commit
        run: |
          git add tests/fixtures/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            git commit -m "chore(tests): fetch test data for ${{ steps.branch.outputs.date }}

            Automated weekly fetch of restaurant menu HTML for testing.

            Generated by GitHub Actions workflow."
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Push branch
        if: steps.commit.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "test: weekly test data fetch for ${{ steps.branch.outputs.date }}" \
            --body "## Weekly Test Data Fetch

          This PR contains automatically fetched test data from restaurant websites for regression testing.

          **Date**: ${{ steps.branch.outputs.date }}

          ### Changes
          - New test fixtures in \`tests/fixtures/${{ steps.branch.outputs.date }}/\`
          - HTML snapshots from:
            - ISS Menyer (Gourmedia)
            - Kvartersmenyn (Filmhuset)
            - Kvartersmenyn (Karavan)

          ### Next Steps
          - Review the fetched data for any anomalies
          - Manually add ISS API response if needed (see \`tests/fixtures/fetch_test_data.py\`)
          - Run tests to ensure parsers still work correctly

          ---
          *Automated by GitHub Actions workflow*" \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }} \
            --label "automated" \
            --label "tests"
